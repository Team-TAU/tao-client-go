---
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

stages:
  - vulnerability
  - test
  - lint
  - build-example

snyk-scan:
  stage: vulnerability
  image: node:14.2
  before_script:
    - apt install -y wget tar
    - wget -q https://dl.google.com/go/go1.16.3.linux-amd64.tar.gz -O /tmp/go1.16.3.linux-amd64.tar.gz
    - tar -C /usr/local -xzf /tmp/go1.16.3.linux-amd64.tar.gz
  script:
    - export PATH=$PATH:/usr/local/go/bin
    - npm install -g snyk
    - snyk auth $SNYK_TOKEN
    - snyk test

unit-test-go:
  stage: test
  parallel:
    matrix:
      - GOVERSION:
          - 1.16
          - 1.15
          - 1.14
          - 1.13
          - 1.12
  image: golang:$GOVERSION
  before_script:
    - go mod download
  script:
    - go test -short $(go list ./... | grep -v /vendor/)
  except:
    - schedules

coverage-report:
  stage: test
  image: golang:1.16
  before_script:
    - go mod download
  script:
    - export PKG_LIST=$(go list ./... | grep -v /vendor/)
    - mkdir cover
    - for package in ${PKG_LIST}; do
      go test -covermode=count -coverprofile "cover/${package##*/}.cov" "$package" ;
      done
    - "echo 'mode: count' > coverage.cov"
    - tail -q -n +2 cover/*.cov >> coverage.cov
    - go tool cover -func=coverage.cov
    - go tool cover -html=coverage.cov -o index.html
  artifacts:
    paths:
      - index.html

lint:
  stage: lint
  image: golang:1.16
  before_script:
    - go mod download
    - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.37.1
  script:
    - golangci-lint run
    - golangci-lint run --out-format junit-xml > junit.xml
  artifacts:
    reports:
      junit:
        - junit.xml
  except:
    - schedules

build-raw-receive-example:
  stage: build-example
  parallel:
    matrix:
      - GOVERSION:
          - 1.16
          - 1.15
          - 1.14
          - 1.13
          - 1.12
  image: golang:$GOVERSION
  before_script:
    - go mod download
  script:
    - go build ./examples/raw-receive/main.go
  except:
    - schedules

build-save-latests-example:
  stage: build-example
  parallel:
    matrix:
      - GOVERSION:
          - 1.16
          - 1.15
          - 1.14
          - 1.13
          - 1.12
  image: golang:$GOVERSION
  before_script:
    - go mod download
  script:
    - go build ./examples/save-latests/main.go
  except:
    - schedules
